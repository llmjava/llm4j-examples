# News article recommendation with Google PaLM and Elasticsearch

This code example illustrates how to use Elasticsearch as a Vector DB to store and search documents using embeddings which were generated by Google PaLM a Large Language Model.

The example uses the [llm4j](https://github.com/llmjava/llm4j) Java library which makes using LLMs like Google PaLM very convenient in java.

## Setup Google PaLM and Elasticsearch
First the application setup the llm4j library to connect to Google PaLM, and also setup a connection to Elasticsearch and creates an index using the following mapping

```json
{
  "mappings": {
    "properties": {
      "title": { "type": "text" },
      "text": { "type": "text" },
      "tags": { "type":  "keyword" },
      "embeddings": { "type": "dense_vector", "dims": 768, "index": true, "similarity": "cosine"}
    }
  }
}
```

## Preprocessing articles
The CSV file `bbc_news_test.csv` containing articles is parsed and `Article` objects are created. Then we process the text of each news article to generate embeddings and extract tags using Google PaLM. After that the final article object is uploaded to Elasticsearch.

### Tags extraction:
We use the following prompt template with examples to ask Google PaLM to extract tags for a news article.
```
String prompt = "Given a news article, this program returns the list tags containing keywords of that article." + "\n"
                + "Article: japanese banking battle at an end japan s sumitomo mitsui financial has withdrawn its takeover offer for rival bank ufj holdings  enabling the latter to merge with mitsubishi tokyo.  sumitomo bosses told counterparts at ufj of its decision on friday  clearing the way for it to conclude a 3 trillion" + "\n"
                + "Tags: sumitomo mitsui financial, ufj holdings, mitsubishi tokyo, japanese banking" + "\n"
                + "--" + "\n"
                + "Article: france starts digital terrestrial france has become the last big european country to launch a digital terrestrial tv (dtt) service.  initially  more than a third of the population will be able to receive 14 free-to-air channels. despite the long wait for a french dtt roll-out" + "\n"
                + "Tags: france, digital terrestrial" + "\n"
                + "--" + "\n"
                + "Article: apple laptop is  greatest gadget  the apple powerbook 100 has been chosen as the greatest gadget of all time  by us magazine mobile pc.  the 1991 laptop was chosen because it was one of the first  lightweight  portable computers and helped define the layout of all future notebook pcs." + "\n"
                + "Tags: apple, apple powerbook 100, laptop" + "\n"
                + "--" + "\n"
                + "Article: " + article.text + "" + "\n"
                + "Tags:";
String rawTags = llm.process(prompt);
```

Google PaLM does a pretty good job with the extraction in most case. For instance, for the article titled `Desailly backs Blues revenge trip` it was able to infer what the news article talk about extract tags such as `chelsea, barcelona`.

### Generating Embeddings:
Google PaLM provides an API to get the embeddings for an input text, using it is straightforward

```java
List<Float> embeddings = llm.embed(text);
```

Note that the call may fail if the text is very long, which is the case for most of the news articles. In such case PaLM will throw the following error.

```java
    io.grpc.StatusRuntimeException: INVALID_ARGUMENT: Request payload size exceeds the limit: 10000 bytes
```

## Recommending articles
We sample one article from the news dataset, get its [embeddings](https://www.elastic.co/guide/en/elasticsearch/reference/current/dense-vector.html) and then ask Elasticsearch with [KNN query](https://www.elastic.co/guide/en/elasticsearch/reference/current/knn-search.html) for similar articles which have the closest embeddings.

In Java, the Elasticsearch-based recommendation query looks like this
```java
SearchRequest request = new SearchRequest.Builder()
    .index(indexName)
    .knn(builder -> builder
        .k(3)
        .numCandidates(10)
        .field("embeddings")
        .queryVector(embeddings)
    )
    .fields(new FieldAndFormat.Builder().field("title").build())
    .build();
SearchResponse<Article> response = esClient.search(request, Article.class);
```